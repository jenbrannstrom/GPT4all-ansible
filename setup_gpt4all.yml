# This script is supposed to: 
# 1. create a VPC in yoru AWS account
# 2. Create subnets within the VPC and set up the route table and internet gateway
# 3. launch Spot instance
# 4. start one of multiple steps to install GPT4ALL

---
- name: Set up GPT4All on AWS
  hosts: localhost
  tasks:
    - name: Create VPC
      amazon.aws.ec2_vpc_net:
        name: "your_vpc_name"
        cidr_block: "10.0.0.0/16"
        region: "us-east-1"
        aws_access_key: "access-key"
        aws_secret_key: "secret-key"
      register: vpc

    - name: Create an Internet Gateway
      amazon.aws.ec2_vpc_igw:
        vpc_id: "{{ vpc.vpc.id }}"
        region: "us-east-1"
        aws_access_key: "access-key"
        aws_secret_key: "secret-key"
      register: igw

    - name: Create a Route Table
      amazon.aws.ec2_vpc_route_table:
        vpc_id: "{{ vpc.vpc.id }}"
        region: "us-east-1"
        aws_access_key: "access-key"
        aws_secret_key: "secret-key"
      register: route_table

    - name: Create a subnet
      amazon.aws.ec2_vpc_subnet:
        state: present
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: "10.0.1.0/24"
        region: "us-east-1"
        aws_access_key: "access-key"
        aws_secret_key: "secret-key"
      register: subnet

    - name: Associate Route Table to Subnet
      amazon.aws.ec2_vpc_route_table:
        state: present
        vpc_id: "{{ vpc.vpc.id }}"
        tags:
          Name: GPT4All Route Table
        subnets:
          - "{{ subnet.subnet.id }}"
        routes:
          - dest: "0.0.0.0/0"
            gateway_id: "{{ igw.gateway_id }}"
        aws_access_key: "access-key"
        aws_secret_key: "secret-key"

    - name: Generate an RSA key pair
      ansible.builtin.openssh_keypair:
        path: "{{ playbook_dir }}/keypair_for_gpt4all"
        type: rsa
        size: 2048
      register: rsa_keypair

    - name: Import the public key to AWS
      amazon.aws.ec2_key:
        name: "Keypair for GPT4ALL"
        region: "us-east-1"
        aws_access_key: "access-key"
        aws_secret_key: "secret-key"
        public_key_material: "{{ rsa_keypair.public_key }}"


    - name: Launch Spot instance
      amazon.aws.ec2:
        state: present
        key_name: "{{ aws_keypair.key.name }}"
        instance_type: t2.micro
        image: ami-06e46074ae430fba6  # Amazon Linux 2 LTS AMI (HVM)
        wait: yes
        vpc_subnet_id: "{{ subnet.subnet.id }}"
        instance_tags:
          Name: GPT4All Instance
        spot_price: "0.0075"
        region: "us-east-1"
        aws_access_key: "access-key"
        aws_secret_key: "secret-key"
        instance_initiated_shutdown_behavior: terminate
      register: ec2



# ... remaining tasks in part 2...
